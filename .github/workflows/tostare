name: Extract zip and Push

on:
  push:
    paths:
      - 'HoldableTemplate_scotland2_ready.zip'
  workflow_dispatch:

jobs:
  extract-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (allow push)
        uses: actions/checkout@v4
        with:
          # you can keep using your custom token secret or remove this line to use the default GITHUB_TOKEN
          token: ${{ secrets.Test }}
          persist-credentials: true

      - name: Extract and flatten ZIP to repo root
        shell: bash
        run: |
          set -euo pipefail

          echo "ğŸ” Looking for HoldableTemplate_scotland2_ready.zip in repo root..."
          ZIP_FILE=$(find . -maxdepth 1 -type f -name "HoldableTemplate_scotland2_ready.zip" -print -quit)

          if [ -z "${ZIP_FILE:-}" ]; then
            echo "âŒ No zip found: HoldableTemplate_scotland2_ready.zip"
            exit 1
          fi

          echo "ğŸ“¦ Found: $ZIP_FILE"
          TMPDIR=$(mktemp -d)
          echo "ğŸ§¾ Extracting into temporary dir: $TMPDIR"
          unzip -q "$ZIP_FILE" -d "$TMPDIR"

          # Detect a single top-level extracted folder (wrapper) and flatten it.
          TOP_DIR_COUNT=$(find "$TMPDIR" -maxdepth 1 -mindepth 1 -type d | wc -l)
          if [ "$TOP_DIR_COUNT" -eq 1 ]; then
            TOP_DIR=$(find "$TMPDIR" -maxdepth 1 -mindepth 1 -type d -print -quit)
            echo "ğŸ“ Single wrapper folder detected: $TOP_DIR"
            echo "ğŸšš Moving contents of wrapper to repo root..."
            shopt -s dotglob
            mv "$TOP_DIR"/* .
            # also move dotfiles from wrapper
            mv "$TOP_DIR"/.[!.]* . 2>/dev/null || true
            rm -rf "$TOP_DIR"
          else
            echo "ğŸ“‚ No single wrapper folder detected (or multiple items). Moving all extracted files to root..."
            shopt -s dotglob
            mv "$TMPDIR"/* .
            mv "$TMPDIR"/.[!.]* . 2>/dev/null || true
          fi

          # cleanup
          rm -rf "$TMPDIR"
          echo "ğŸ§¹ Removing original zip: $ZIP_FILE"
          rm -f "$ZIP_FILE"

          echo "âœ… Extraction + flatten complete. Current root contents:"
          ls -la

      - name: Commit and push changes (if any)
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # show status for debugging
          echo "Status before add:"
          git status --porcelain || true

          git add -A

          # If there are staged changes, commit and push
          if ! git diff --cached --quiet; then
            echo "ğŸ” Changes detected â€” committing and pushing..."
            git commit -m "Extract HoldableTemplate_scotland2_ready.zip into repo root (automated)"
            git push
          else
            echo "âœ“ No changes to commit"
          fi
